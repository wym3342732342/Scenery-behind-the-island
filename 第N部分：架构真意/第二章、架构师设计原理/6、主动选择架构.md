&emsp;&emsp;理想的架构不会主动送上门来，积极主动地思考和选择才能提高成功的机会。
&emsp;&emsp;架构设计就是在不确定的情况下做决策，决策就是取舍。我们不得不做一些妥协，放弃一些东西以避免更坏的情况发生，**帮助利益相关方完成业务目标**。

## 1、发散探索、聚合决策
&emsp;&emsp;做决策意味着需要多个备选方案。如果没得选，那就不需要决策了。要获得备选方案，就需要进行**设计探索**。

&emsp;&emsp;设计探索是反复地发散和聚合的过程。探索解决问题的各种方案，找到备选之后在聚合思维，取得共识，排除不合适的方案。

![image-20220430165725997](https://gitee.com/tizo_kingbb/picImg/raw/master/img/20220430165726.png)

### 1.1探索架构关键点
&emsp;&emsp;所有的架构都是设计，但并非所有的设计都是架构。软件架构是关于如何组织软件的一系列重大决策的集合，皆在**实现期望的质量属性和其他软件特性**。

以下是架构设计通常要探索的几个方面：
- **探索元素及其作用，确定架构的结构组成**：每个元素都应该有明确的作用，如果没有那么就应该被剔除；
- **探索关系及其接口，确定元素的交互方式**：描述架构中元素间如何协同工作完成任务。组件接口就是一种关系。
- **探索问题领域，理解架构所处的环境**：每类问题都有自己的术语和概念，描述了它存在的环境，已经其所在领域中的概念。对问题领域理解的越透彻，对架构元素的划分及功能分配就越理想。
- 探索技术和框架，提升质量属性：任何现成的技术都带有“偏好”和“态度”。理解他们的特点才能更好的发挥其作用。
- **探索构建和部署方法，确保架构可以交付**：架构会影响软件的构建和部署方式。如果你想持续交付、多位开发人员并行工作、使用特定的测试策略，都需要在设计架构时考虑好。
- **探索以往的设计，获得启发，指导决策**：所有的设计都是在**已有设计基础上**重新设计和调整创新。大多数的架构探索始于温故——审视已知的软件设计知识。这种知识来源于你以往的工作，也来自多年来架构师社区积累的经验。

> 不要忽视部署的一致性
> &emsp;&emsp;设计具有多个实例的系统或服务时。最容易忽视的是部署的一致性。目前有两种发版的方式：红黑部署和滚动更新。
> &emsp;&emsp;如果是滚动更新，那么将会有两个不用接口的服务同时运行。此时你可能需要向后兼容。部署多实例同时运行的服务和容易出现不一致的情况。

## 2、接受 约束
&emsp;&emsp;面对技术约束，我们别无选择。接受约束后我们可以在以下几个方面做更多的考虑：
- 选择有利于并行开发的工作模式。
- 选择有利于增量交付的模式。
- 选择团队熟悉的技术以降低风险。
- 选择支持自动化并能加快开发速度的技术。
- 不做太多设计规划，**接受技术负债**，开发“大泥球”。

&emsp;&emsp;业务约束还可能在架构之外得到满足，比如挑选工作能力强的开发人员，提前开展测试，活着将部分任务分包出去。
&emsp;&emsp;早期的设计决策也可能成为约束，架构决策就像是房屋的承重墙，它框定了其他东西的大致位置。这种决策一定要控制在可更改的范围内。虽然移动承重墙代价很高，但终究是可行的。一定要分清自己选定的约束与外界的约束。


## 3、提升质量属性
&emsp;&emsp;此处我们把开发软件比作制作沙冰，要做好沙冰你就需要一个搅拌机。搅拌机起到了决定性的作用。

对比一下质量属性：

|              | 标准搅拌机 | 手持搅拌机 | 链锯搅拌机 |
| ------------ | :--------: | :--------: | :--------: |
| 易清洗性     |     中     |     优     |     中     |
| 适合厨房安装 |     优     |     中     |    特劣    |
| 安静程度     |     中     |     优     |    特劣    |
| 动力         |     中     |     劣     |    特优    |
| 便携性       |     劣     |    特优    |     优     |
| 安全性       |     中     |     中     |     劣     |

> &emsp;&emsp;最中你将通过需求权衡后选择一个适合你的搅拌机。同理架构师也是在选择结构，而选择结构通常指的就是探索各种架构模式。请记住，**所有的设计都是在已有设计基础上的重新设计和调整创新。**找到能够提升既定质量属性的架构模式。
> 

### 3.1 借助质量属性探索架构模式
&emsp;&emsp;假设要构建一个数据驱动的web应用。那么你会选择哪种架构？
- 三层模式（3-tier pattern）：每层完成不用的任务。
- 发布-订阅模式（publish-subscribe pattern）：所有元素都将消息发布到事件总线上。事件可能不按顺序传送，也不确保传送成功（视消息系统的规则而定）
- 面向服务架构模式（service-oriented architecture pattern）：服务都在中央注册表注册。组件查找并直接调用这些服务。

![image-20220430222423044](https://gitee.com/tizo_kingbb/picImg/raw/master/img/20220430222423.png)



**三种模式分别提升和抑制了不同的质量属性：**
- 三层模式：易于测试、部署、描述；但也很难提升可伸缩性和可用性等质量属性；
- 发布-订阅模式：有较高的可更改性和灵活性，可以轻松构建松耦合系统；缺点是消息顺序对事件有影响，不能保证正确消息顺序的情况下会让这种模式不够干净利索。
- 面向服务模式：可更改、灵活、可测试。易于扩展，容易提升可用性。但是它相对是复杂的，架构设计的工作量最大。

### 3.2 运用决策矩阵
&emsp;&emsp;决策矩阵是一个简单的表格，用于总结分析多个架构设计方案的利弊。

| 需要分析的特性\架构设计选项 | 选项A | 选项B | 选项C |
| --------------------------- | :---: | :---: | :---: |
| 特性1                       | 妨碍  |   -   |   ⬇️   |
| 特性2                       | 提升  |   +   |   ⬆️   |
| 特性3                       | 中等  |   0   |   ➡️   |



**矩阵中文字符号的含义：**

| 强提升   | 设计选项能高效实现系统特性。         |
| :------- | ------------------------------------ |
| 提升     | 设计选项能正常实现系统特性。         |
| 中等     | 设计选项记不提升也不妨碍系统特性。   |
| 妨碍     | 设计选项给实现系统特性带来麻烦。     |
| 严重妨碍 | 设计选项给实现系统特性造成极大困难。 |



> &emsp;&emsp;最佳决策通常是显而易见的，通过表格总结分析就可以排除那些阻碍实现的选项了。⚠️注意：别用数字打分。



## 4、为架构元素分配功能

&emsp;&emsp;每个元素分配特定的功能，以便实现所有既定的功能需求。我们找一个例子来简单说明一下。

![image-20220501102052407](https://gitee.com/tizo_kingbb/picImg/raw/master/img/20220501102052.png)



|       元素       | 功能                                                         |
| :--------------: | ------------------------------------------------------------ |
|     web界面      | 在用户浏览器中渲染用户界面，处理用户交互。                   |
|     展示业务     | 认证和授权，作为其他支持服务的接口，<br/>为程序调用验证业务逻辑。 |
|     搜索服务     | 处理查询解析、搜索、分页、过滤。                             |
|     收藏服务     | 标准化标签，将用户收藏进行永久存储                           |
|     提醒服务     | 定期查询近期更改，根据用户数据库中的订阅信息发送提醒邮件     |
|       爬虫       | 从合同数据库中读取数据并进行转换，再添加到索引中。           |
|    用户数据库    | 用户订阅和其他用户输入内容的永久存储                         |
|     搜索索引     | 合同数据的优化呈现，便于搜索。<br/>界面中展示的所有合同数据都是可搜索、<br/>可排序的，存储于数据库中。 |
|    合同数据库    | 永久存储。招投标合同数据记录系统。                           |
|    关系：HTTP    | 基于标准的`HTTP`协议服务通信。`API`默认是`RESTful`。         |
| 关系：数据库驱动 | 待选定的数据库的原生驱动程序/客户端。                        |



> &emsp;&emsp;审视影响较大的功能需求，创建元素功能表。每个元素都至少应该负责一个功能，否则元素就失去了存在的意义。**影响较大的功能需求可以作为检查清单。**



## 5、设计，应变而生

&emsp;&emsp;在理解关键架构需求的基础上探索设计方案，进行设计决策。做好关键的设计决策是打造稳健的架构的关键。不过**软件里唯一不变的就是变化**。

&emsp;&emsp;所有优秀的架构师都明白变更是不可避免的。将设计决策移出架构，做到“应变设计”。



### 5.1 推迟决策

&emsp;&emsp;避免走入死胡同或走上歧路的办法是推迟决策（不到最后一刻不做决定）。《敏捷软件开发工具》提出了“最后责任时刻”，而我们建议**“最佳责任时刻”**做决策。

&emsp;&emsp;理想情况下，最佳责任时刻就是最后责任时刻。但是实践中，最佳时刻要求我们留出额外的时间，以便处理无法掌控的外部依赖、建立共识、培训、验证设计。



**如何找出最佳时机：**

- 不做决策是否阻碍了项目进展？
- 决策能否解决不能再耽搁的问题？
- 决策是否会创造更多选项或机会？
- 推迟决策是否明显会带来更多风险？
- 我是否理解并接受决策带来的一切后果？
- 我有明确的理由说明为什么现在必须做这个决定吗？
- 如果决策失误，是否有时间弥补？我能承受这样的错误吗？



> &emsp;&emsp;即使我们找到了最佳时机但是也不一定有足够的信息进行决策，还有一个窍门：**把容易变化的东西移出架构，这样可以有效避免情况恶化。**



### 5.2 将设计决策移出架构

&emsp;&emsp;如果决策容易发生变化，那么它就不再是一个架构问题。在可能的情况下，把**容易变化的决策留给后续设计人员来做。**

&emsp;&emsp;许多编程原则也可以作为很好的设计原则。例如：**`SOLID`**原则，如果架构中的元素具有**单一功能，它就容易被隔离更改。创建接口清晰的元素能带来更多的灵活性。**

&emsp;&emsp;有很多方法可以将设计决策移出架构，比如：**可插拔/可替换结构（pluggable）**、**外部配置**、**自描述数据**、**动态发现**。这些都是在设计时（designtime）或运行时（runtime）更改系统的行为（而不修改架构）。

